<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premier League Predictor League</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <!-- React and Babel for running JSX directly in the browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">

    <div id="root"></div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules globally so they can be accessed by the Babel script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, setLogLevel
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs } = window.firebase || {};

        // --- CONFIGURATION SETUP (FIXED) ---

        let config, token, appIdentifier;

        // Check for Canvas environment globals (Fixes the API Key error)
        if (typeof __firebase_config !== 'undefined') {
            config = JSON.parse(__firebase_config);
            token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            appIdentifier = typeof __app_id !== 'undefined' ? __app_id : 'pl-predictor-default';
        } else {
            // Running on a public site (GitHub Pages) - REQUIRES USER INPUT
            // ðŸ›‘ YOU MUST REPLACE THESE PLACEHOLDERS WITH YOUR ACTUAL KEYS FOR GITHUB PAGES ðŸ›‘
            const YOUR_PUBLIC_FIREBASE_CONFIG = {
                apiKey: "AIzaSyDWepvqTGqLcjziToDwwbj48oZNRplJX_M",
  					authDomain: "premier-league-predictor-live.firebaseapp.com",
  					projectId: "premier-league-predictor-live",
  					storageBucket: "premier-league-predictor-live.firebasestorage.app",
  					messagingSenderId: "599727798420",
  					appId: "1:599727798420:web:f2cbe07ca328db5aab1c81"
            };
            config = YOUR_PUBLIC_FIREBASE_CONFIG;
            token = null; 
            appIdentifier = config.projectId || 'pl-predictor-default'; 
        }

        const firebaseConfig = config;
        const initialAuthToken = token;
        const appId = appIdentifier;

        // --- END CONFIGURATION SETUP ---


        // --- APP CONFIGURATION ---

        const CURRENT_GAMEWEEK = 14;

        const PREMIER_LEAGUE_TEAMS = [
            'Arsenal', 'Aston Villa', 'Bournemouth', 'Brentford', 'Brighton and Hove Albion',
            'Burnley', 'Chelsea', 'Crystal Palace', 'Everton', 'Fulham',
            'Leeds United', 'Leicester City', 'Liverpool', 'Manchester City', 'Manchester United', 
            'Newcastle United', 'Nottingham Forest', 'Southampton', 'Tottenham Hotspur', 'West Ham United', 
            'Wolverhampton Wanderers'
        ].sort();

        // Initial hardcoded matches for the current gameweek (GW14)
        const GAMEWEEK_MATCHES = [
            { id: 'bou_eve', home: 'Bournemouth', away: 'Everton' },
            { id: 'ful_mci', home: 'Fulham', away: 'Manchester City' },
            { id: 'new_tot', home: 'Newcastle United', away: 'Tottenham Hotspur' },
            { id: 'ars_bre', home: 'Arsenal', away: 'Brentford' },
            { id: 'bha_avl', home: 'Brighton and Hove Albion', away: 'Aston Villa' },
            { id: 'bur_cry', home: 'Burnley', away: 'Crystal Palace' },
            { id: 'wol_nfo', home: 'Wolverhampton Wanderers', away: 'Nottingham Forest' },
            { id: 'lee_che', home: 'Leeds United', away: 'Chelsea' },
            { id: 'liv_sun', home: 'Liverpool', away: 'Sunderland' }, 
            { id: 'mun_whu', home: 'Manchester United', away: 'West Ham United' },
        ];

        const SCORING_RULES = {
            SPOT_ON: 5,
            CORRECT_RESULT: 2,
            GOAL_THRILLER_BONUS: 5,
        };

        // --- SCORING LOGIC ---

        const calculateScore = (prediction, result) => {
            if (prediction.home === '' || prediction.away === '' || result.home === '' || result.away === '') {
                return 0;
            }

            const p_h = parseInt(prediction.home, 10);
            const p_a = parseInt(prediction.away, 10);
            const r_h = parseInt(result.home, 10);
            const r_a = parseInt(result.away, 10);

            let score = 0;

            // 1. Check for Spot-on Score
            if (p_h === r_h && p_a === r_a) {
                score = SCORING_RULES.SPOT_ON;
                const totalGoals = r_h + r_a;
                if (totalGoals >= 6) {
                    score += SCORING_RULES.GOAL_THRILLER_BONUS;
                }
                return score;
            }

            // Determine the result sign: 1 (Home Win), -1 (Away Win), 0 (Draw)
            const getResultSign = (h, a) => {
                if (h > a) return 1;
                if (h < a) return -1;
                return 0;
            };

            const actualSign = getResultSign(r_h, r_a);
            const predictedSign = getResultSign(p_h, p_a);

            // 2. Check for Correct Result (Win/Draw)
            if (actualSign === predictedSign) {
                score = SCORING_RULES.CORRECT_RESULT;
            }

            return score;
        };

        // --- REACT COMPONENT ---

        const App = () => {
            // Firebase State
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            // App State
            const [activeTab, setActiveTab] = useState('predict');
            
            // Prediction State
            const [predictionInput, setPredictionInput] = useState({});
            const [savedPredictions, setSavedPredictions] = useState({});

            // Official Results and Leaderboard
            const [officialResults, setOfficialResults] = useState({});
            const [leaderboard, setLeaderboard] = useState([]);
            const [message, setMessage] = useState('');
            const [loading, setLoading] = useState(true);

            // Admin Panel State
            const [adminGw, setAdminGw] = useState(CURRENT_GAMEWEEK); 
            const [adminMatchResults, setAdminMatchResults] = useState({}); 
            const [adminMatchSetup, setAdminMatchSetup] = useState([]); 
            const [newMatchHomeTeam, setNewMatchHomeTeam] = useState('');
            const [newMatchAwayTeam, setNewMatchAwayTeam] = useState('');

            // --- FIREBASE INITIALIZATION & AUTH ---
            useEffect(() => {
                if (!initializeApp) {
                    setMessage("Firebase SDK not loaded. Check script imports.");
                    setLoading(false);
                    return;
                }
                
                if (!Object.keys(firebaseConfig).length || firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                    setMessage("âš ï¸ Warning: Firebase configuration is using placeholder keys. Please update them for public deployment.");
                    // Still proceed with anonymous sign-in attempt
                }

                try {
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);

                    setDb(dbInstance);

                    const authenticate = async () => {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(authInstance, initialAuthToken);
                            } else {
                                await signInAnonymously(authInstance);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            setMessage(`Authentication failed: ${error.message}`);
                        }
                    };

                    authenticate();

                    const unsubscribe = onAuthStateChanged(authInstance, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            setUserId(null);
                        }
                        setIsAuthReady(true);
                        setLoading(false);
                    });

                    return () => unsubscribe();

                } catch (error) {
                    console.error("Initialization Error:", error);
                    setMessage(`App initialization failed: ${error.message}`);
                    setLoading(false);
                }
            }, []);

            // --- FIRESTORE PATHS ---
            const getPredictionDocRef = useCallback((uId, gw) => {
                if (!db) return null;
                // Private Data: /artifacts/{appId}/users/{userId}/predictions/{gameweek}
                return doc(db, 'artifacts', appId, 'users', uId, 'predictions', String(gw));
            }, [db, appId]);

            const getOfficialResultsDocRef = useCallback((gw) => {
                if (!db) return null;
                // Public Data: /artifacts/{appId}/public/data/results/{gameweek}
                return doc(db, 'artifacts', appId, 'public', 'data', 'results', String(gw));
            }, [db, appId]);

            const getAllUserPredictionsCollectionRef = useCallback(() => {
                if (!db) return null;
                // Public Data: /artifacts/{appId}/public/data/all_predictions
                return collection(db, 'artifacts', appId, 'public', 'data', 'all_predictions');
            }, [db, appId]);

            // --- DATA LISTENERS ---

            // Listener 1: Fetch Current User's Predictions (Private, focuses on CURRENT_GAMEWEEK)
            useEffect(() => {
                if (!db || !userId) return;

                const docRef = getPredictionDocRef(userId, CURRENT_GAMEWEEK);

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setSavedPredictions(data.predictions || {});
                        setPredictionInput(data.predictions || {});
                    } else {
                        setSavedPredictions({});
                    }
                }, (error) => console.error("Error reading user prediction:", error));

                return () => unsubscribe();
            }, [db, userId, getPredictionDocRef]);


            // Listener 2: Fetch Official Results for CURRENT_GAMEWEEK (Public)
            useEffect(() => {
                if (!db || !isAuthReady) return;

                const docRef = getOfficialResultsDocRef(CURRENT_GAMEWEEK);

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setOfficialResults(docSnap.data().results || {});
                    } else {
                        setOfficialResults({});
                    }
                }, (error) => console.error("Error reading official results:", error));

                return () => unsubscribe();
            }, [db, isAuthReady, getOfficialResultsDocRef]);


            // Listener 3: Fetch Official Results for Admin GW (Public)
            useEffect(() => {
                if (!db || !isAuthReady || activeTab !== 'admin') return; 

                const docRef = getOfficialResultsDocRef(adminGw);

                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const results = docSnap.data().results || {};
                        setAdminMatchResults(results);
                        
                        const matches = Object.keys(results).map(id => {
                            const savedMatchData = results[id];
                            const homeTeam = savedMatchData.homeTeam || id.split('_')[0];
                            const awayTeam = savedMatchData.awayTeam || id.split('_')[1];

                            return { 
                                id, 
                                home: homeTeam, 
                                away: awayTeam, 
                                homeScore: savedMatchData.home, 
                                awayScore: savedMatchData.away 
                            };
                        });

                        if (matches.length === 0 && adminGw === CURRENT_GAMEWEEK) {
                            setAdminMatchSetup(GAMEWEEK_MATCHES.map(m => ({
                                ...m,
                                homeScore: '',
                                awayScore: ''
                            })));
                        } else {
                            setAdminMatchSetup(matches);
                        }

                    } else {
                        setAdminMatchResults({});
                        if (adminGw === CURRENT_GAMEWEEK) {
                            setAdminMatchSetup(GAMEWEEK_MATCHES.map(m => ({
                                ...m,
                                homeScore: '',
                                awayScore: ''
                            })));
                        } else {
                            setAdminMatchSetup([]);
                        }
                    }
                }, (error) => console.error(`Error reading Admin GW${adminGw} results:`, error));

                return () => unsubscribe();
            }, [db, isAuthReady, adminGw, activeTab, getOfficialResultsDocRef]);


            // Listener 4: Fetch ALL Predictions and Calculate Leaderboard (Public)
            useEffect(() => {
                if (!db || !isAuthReady) return;

                const allPredsColRef = getAllUserPredictionsCollectionRef();

                const calculateLeaderboard = async () => {
                    const results = officialResults;

                    // 1. Fetch all predictions for all users
                    const q = query(allPredsColRef);
                    const snapshot = await getDocs(q);

                    const allPredictionsData = {};
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const uId = data.userId;
                        const gw = data.gameweek;

                        if (!allPredictionsData[uId]) {
                            allPredictionsData[uId] = {
                                userId: uId,
                                totalScore: 0,
                                predictions: {}
                            };
                        }

                        if (gw === CURRENT_GAMEWEEK) {
                            allPredictionsData[uId].predictions = data.predictions || {};
                        }
                    });

                    // 2. Calculate scores
                    const finalLeaderboard = Object.values(allPredictionsData).map(player => {
                        let gwScore = 0;

                        GAMEWEEK_MATCHES.forEach(match => {
                            const pred = player.predictions[match.id];
                            const res = results[match.id];

                            if (pred && res) {
                                gwScore += calculateScore(pred, res);
                            }
                        });

                        player.totalScore = gwScore;
                        return player;
                    });

                    // 3. Sort and Update Leaderboard
                    finalLeaderboard.sort((a, b) => b.totalScore - a.totalScore);
                    setLeaderboard(finalLeaderboard);
                    setLoading(false);
                };

                calculateLeaderboard();

            }, [db, isAuthReady, officialResults, getAllUserPredictionsCollectionRef]);


            // --- DATA HANDLERS ---

            const handlePredictionChange = (matchId, type, value) => {
                const score = value === '' ? '' : Math.max(0, parseInt(value, 10));

                setPredictionInput(prev => ({
                    ...prev,
                    [matchId]: {
                        ...prev[matchId],
                        [type]: score
                    }
                }));
            };

            const handleSavePrediction = async () => {
                if (!db || !userId) {
                    setMessage("Error: Not authenticated or Firestore not ready.");
                    return;
                }

                try {
                    setLoading(true);
                    setMessage("Saving prediction...");

                    // 1. Save to Private Storage (User's personal record)
                    const privateDocRef = getPredictionDocRef(userId, CURRENT_GAMEWEEK);
                    const privateData = {
                        gameweek: CURRENT_GAMEWEEK,
                        predictions: predictionInput,
                        timestamp: new Date().toISOString()
                    };
                    await setDoc(privateDocRef, privateData, { merge: true });

                    // 2. Save to Public Collection (For Leaderboard calculation)
                    const publicDocId = `${userId}-${CURRENT_GAMEWEEK}`;
                    const publicDocRef = doc(getAllUserPredictionsCollectionRef(), publicDocId);
                    const publicData = {
                        userId: userId,
                        gameweek: CURRENT_GAMEWEEK,
                        predictions: predictionInput,
                        timestamp: new Date().toISOString()
                    };
                    await setDoc(publicDocRef, publicData, { merge: true });

                    setMessage("Prediction saved successfully! Check the Leaderboard tab.");
                } catch (e) {
                    console.error("Error saving prediction: ", e);
                    setMessage(`Failed to save prediction: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // Admin Handlers
            const handleAdminMatchChange = (index, type, value) => {
                const score = value === '' ? '' : Math.max(0, parseInt(value, 10));
                setAdminMatchSetup(prev => {
                    const newSetup = [...prev];
                    newSetup[index][type] = score;
                    return newSetup;
                });
            };

            const handleAdminAddMatch = (home, away) => {
                if (home === '' || away === '' || home === away) {
                    setMessage("Please select two different teams.");
                    return;
                }

                const newId = `${home.replace(/\s/g, '').toLowerCase()}_${away.replace(/\s/g, '').toLowerCase()}`;
                const reverseId = `${away.replace(/\s/g, '').toLowerCase()}_${home.replace(/\s/g, '').toLowerCase()}`;

                if (adminMatchSetup.some(m => m.id === newId || m.id === reverseId)) {
                    setMessage("This fixture (or the reverse) already exists for this gameweek.");
                    return;
                }

                setAdminMatchSetup(prev => [
                    ...prev,
                    { 
                        id: newId, 
                        home: home, 
                        away: away, 
                        homeScore: '', 
                        awayScore: '' 
                    }
                ]);
                setMessage(`Added match: ${home} vs ${away}. Don't forget to save the results!`);
                setNewMatchHomeTeam('');
                setNewMatchAwayTeam('');
            };

            const handleAdminDeleteMatch = (matchId) => {
                setAdminMatchSetup(prev => prev.filter(match => match.id !== matchId));
                setMessage("Match deleted from the current setup. Remember to save changes.");
            };

            const handleSaveOfficialResults = async () => {
                if (!db) {
                    setMessage("Error: Firestore not ready.");
                    return;
                }

                try {
                    setLoading(true);
                    setMessage(`Saving official results for GW${adminGw}...`);

                    const resultsPayload = {};
                    adminMatchSetup.forEach(match => {
                        const homeScore = match.homeScore === '' ? '' : parseInt(match.homeScore, 10);
                        const awayScore = match.awayScore === '' ? '' : parseInt(match.awayScore, 10);
                        
                        if (match.id && match.home && match.away) {
                            resultsPayload[match.id] = {
                                home: homeScore,
                                away: awayScore,
                                homeTeam: match.home,
                                awayTeam: match.away
                            };
                        }
                    });

                    const docRef = getOfficialResultsDocRef(adminGw);
                    const data = {
                        gameweek: adminGw,
                        results: resultsPayload,
                        timestamp: new Date().toISOString()
                    };
                    await setDoc(docRef, data, { merge: true });

                    setMessage(`Official results for GW${adminGw} saved successfully!`);
                } catch (e) {
                    console.error("Error saving results: ", e);
                    setMessage(`Failed to save official results: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };


            // --- RENDERING COMPONENTS ---

            const renderGameweekSelector = (currentGw, setter) => (
                <div className="flex items-center space-x-2">
                    <label className="text-gray-600 font-medium whitespace-nowrap">Select Gameweek:</label>
                    <input
                        type="number"
                        min="1"
                        max="38"
                        value={currentGw}
                        onChange={(e) => setter(Math.max(1, Math.min(38, parseInt(e.target.value) || 1)))}
                        className="w-20 p-2 border border-gray-300 rounded-lg text-center focus:ring-rose-500 focus:border-rose-500 transition"
                    />
                </div>
            );

            const renderPredictionForm = () => (
                <div className="space-y-6">
                    <h2 className="text-2xl font-semibold text-gray-800">Your Predictions (GW{CURRENT_GAMEWEEK})</h2>
                    <p className="text-sm text-gray-500">Enter your score predictions below for the current gameweek. Click Save to submit them to the league.</p>

                    <div className="bg-white p-4 rounded-xl shadow-lg space-y-4 border">
                        {GAMEWEEK_MATCHES.map(match => (
                            <div key={match.id} className="flex flex-col items-center justify-between p-3 border-b last:border-b-0">
                                <div className="flex items-center justify-between w-full">
                                    <span className="font-bold text-gray-800 text-left whitespace-nowrap flex-1 min-w-0 pr-2 overflow-hidden text-ellipsis">
                                        {match.home}
                                    </span>
                                    <div className="flex items-center space-x-2 flex-shrink-0">
                                        <input
                                            type="number"
                                            min="0"
                                            value={predictionInput[match.id]?.home ?? ''}
                                            onChange={(e) => handlePredictionChange(match.id, 'home', e.target.value)}
                                            className="w-12 p-2 border border-gray-300 rounded-lg text-center focus:ring-rose-500 focus:border-rose-500 transition"
                                            placeholder="0"
                                        />
                                        <span className="font-bold text-lg text-gray-700">-</span>
                                        <input
                                            type="number"
                                            min="0"
                                            value={predictionInput[match.id]?.away ?? ''}
                                            onChange={(e) => handlePredictionChange(match.id, 'away', e.target.value)}
                                            className="w-12 p-2 border border-gray-300 rounded-lg text-center focus:ring-rose-500 focus:border-rose-500 transition"
                                            placeholder="0"
                                        />
                                    </div>
                                    <span className="text-gray-800 text-right whitespace-nowrap flex-1 min-w-0 pl-2 overflow-hidden text-ellipsis">
                                        {match.away}
                                    </span>
                                </div>
                                <div className="w-full text-xs text-center mt-2 text-rose-600 font-semibold">
                                    {savedPredictions[match.id] ? `Saved: ${savedPredictions[match.id].home}-${savedPredictions[match.id].away}` : 'Not saved'}
                                </div>
                            </div>
                        ))}
                    </div>
                    <button
                        onClick={handleSavePrediction}
                        disabled={loading || !userId}
                        className="w-full sm:w-auto px-6 py-3 bg-rose-600 hover:bg-rose-700 text-white font-bold rounded-xl shadow-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        {loading ? 'Submitting...' : `Save GW${CURRENT_GAMEWEEK} Prediction`}
                    </button>
                </div>
            );

            const renderAdminResultsInput = () => (
                <div className="space-y-6">
                    <h2 className="text-2xl font-semibold text-rose-600">Admin Results Input Panel (Access for all users)</h2>
                    <p className="text-sm text-gray-500">Input and save the *actual* final scores for any gameweek. This updates the official results and the leaderboard.</p>
                    
                    <div className="flex flex-col sm:flex-row items-center justify-between p-4 rounded-xl shadow-inner space-y-3 sm:space-y-0" style={{backgroundColor: '#E9005210'}}>
                        {renderGameweekSelector(adminGw, setAdminGw)}
                        <button
                            onClick={handleSaveOfficialResults}
                            disabled={loading}
                            className="w-full sm:w-auto px-6 py-2 bg-rose-600 hover:bg-rose-700 text-white font-bold rounded-xl shadow-md transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {loading ? 'Saving Results...' : `Save GW${adminGw} Results`}
                        </button>
                    </div>

                    <h3 className="text-xl font-semibold text-gray-700 mt-6">Current Matches for GW{adminGw}</h3>
                    
                    <div className="bg-white p-4 rounded-xl shadow-lg space-y-4 border">
                        {adminMatchSetup.length === 0 && (
                            <p className="text-gray-500 p-4 text-center">No matches defined for GW{adminGw}. Use the form below to add fixtures.</p>
                        )}
                        {adminMatchSetup.map((match, index) => (
                            <div key={match.id + index} className="flex flex-col items-center justify-between p-3 border-b last:border-b-0">
                                <div className="flex items-center justify-between w-full">
                                    <span className="font-bold text-gray-800 text-left whitespace-nowrap flex-1 min-w-0 pr-2 overflow-hidden text-ellipsis">
                                        {match.home}
                                    </span>
                                    <div className="flex items-center space-x-2 flex-shrink-0">
                                        <input
                                            type="number"
                                            min="0"
                                            value={match.homeScore ?? ''}
                                            onChange={(e) => handleAdminMatchChange(index, 'homeScore', e.target.value)}
                                            className="w-12 p-2 border border-rose-300 rounded-lg text-center focus:ring-rose-500 focus:border-rose-500 transition"
                                            placeholder="0"
                                        />
                                        <span className="font-bold text-lg text-gray-700">-</span>
                                        <input
                                            type="number"
                                            min="0"
                                            value={match.awayScore ?? ''}
                                            onChange={(e) => handleAdminMatchChange(index, 'awayScore', e.target.value)}
                                            className="w-12 p-2 border border-rose-300 rounded-lg text-center focus:ring-rose-500 focus:border-rose-500 transition"
                                            placeholder="0"
                                        />
                                    </div>
                                    <div className="flex items-center justify-end flex-1 min-w-0 pl-2 space-x-2">
                                        <span className="text-gray-800 text-right whitespace-nowrap overflow-hidden text-ellipsis">
                                            {match.away}
                                        </span>
                                        <button
                                            onClick={() => handleAdminDeleteMatch(match.id)}
                                            className="text-rose-500 hover:text-rose-700 p-1 rounded-full hover:bg-rose-100 transition flex-shrink-0"
                                            title="Delete Match"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clipRule="evenodd" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    <h3 className="text-xl font-semibold text-gray-700 mt-8">Add New Fixture for GW{adminGw}</h3>
                    <div className="bg-gray-100 p-4 rounded-xl shadow-inner flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-4">
                        <select
                            value={newMatchHomeTeam}
                            onChange={(e) => setNewMatchHomeTeam(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg flex-1 focus:ring-rose-500 focus:border-rose-500"
                        >
                            <option value="">Select Home Team</option>
                            {PREMIER_LEAGUE_TEAMS.filter(t => t !== newMatchAwayTeam).map(team => (
                                <option key={team} value={team}>{team}</option>
                            ))}
                        </select>
                        <span className="font-bold text-lg text-center">VS</span>
                        <select
                            value={newMatchAwayTeam}
                            onChange={(e) => setNewMatchAwayTeam(e.target.value)}
                            className="p-2 border border-gray-300 rounded-lg flex-1 focus:ring-rose-500 focus:border-rose-500"
                        >
                            <option value="">Select Away Team</option>
                            {PREMIER_LEAGUE_TEAMS.filter(t => t !== newMatchHomeTeam).map(team => (
                                <option key={team} value={team}>{team}</option>
                            ))}
                        </select>
                        <button
                            onClick={() => handleAdminAddMatch(newMatchHomeTeam, newMatchAwayTeam)}
                            className="px-4 py-2 bg-rose-600 hover:bg-rose-700 text-white font-semibold rounded-xl transition disabled:opacity-50"
                            disabled={!newMatchHomeTeam || !newMatchAwayTeam}
                        >
                            Add Match
                        </button>
                    </div>
                </div>
            );

            const renderLeaderboard = () => (
                <div className="space-y-6">
                    <h2 className="text-2xl font-semibold text-gray-800">League Leaderboard</h2>
                    <p className="text-sm text-gray-500">Scores are calculated based on all submitted predictions and the official results for GW{CURRENT_GAMEWEEK}.</p>

                    <div className="overflow-x-auto bg-white rounded-xl shadow-lg">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player ID</th>
                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">GW{CURRENT_GAMEWEEK} Score</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {leaderboard.length === 0 ? (
                                    <tr>
                                        <td colSpan="3" className="px-6 py-4 text-center text-sm text-gray-500">No predictions submitted yet, or results are missing.</td>
                                    </tr>
                                ) : (
                                    leaderboard.map((player, index) => (
                                        <tr key={player.userId} className={player.userId === userId ? 'bg-rose-50 font-bold' : 'hover:bg-gray-50'}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{index + 1}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900 break-all">{player.userId} {player.userId === userId && '(You)'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-center text-lg font-extrabold text-rose-700">{player.totalScore}</td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );


            if (loading && !isAuthReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-white p-4">
                        <div className="text-center p-6 bg-white rounded-xl shadow-lg">
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-rose-500 mx-auto mb-3"></div>
                            <p className="text-gray-600">Initializing Predictor League...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 p-4 sm:p-8 font-sans">
                    <div className="max-w-4xl mx-auto">
                        <header className="text-center mb-10">
                            <h1 className="text-4xl font-extrabold text-gray-900 mb-2">âš½ Premier League Predictor</h1>
                            <p className="text-md text-gray-600">Gameweek {CURRENT_GAMEWEEK} Challenge</p>
                            <div className="text-sm text-gray-400 mt-2 flex justify-center items-center">
                                Your User ID: <span className="font-mono text-gray-700 break-all ml-1 mr-4">{userId || 'Loading...'}</span>
                                {userId && (
                                    <button 
                                        onClick={() => setActiveTab('admin')}
                                        className="px-3 py-1 bg-rose-600 hover:bg-rose-700 text-white font-semibold rounded-lg shadow-md transition"
                                    >
                                        Go to Admin Panel
                                    </button>
                                )}
                            </div>
                        </header>

                        {/* Tabs Navigation */}
                        <div className="flex justify-center mb-8 border-b border-gray-200">
                            <button
                                onClick={() => setActiveTab('predict')}
                                className={`py-3 px-6 text-sm font-medium transition-colors duration-200 ${activeTab === 'predict' ? 'border-b-4 border-rose-600 text-rose-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                Make Prediction
                            </button>
                            <button
                                onClick={() => setActiveTab('leaderboard')}
                                className={`py-3 px-6 text-sm font-medium transition-colors duration-200 ${activeTab === 'leaderboard' ? 'border-b-4 border-rose-600 text-rose-600' : 'text-gray-500 hover:text-gray-700'}`}
                            >
                                Leaderboard
                            </button>
                        </div>

                        {/* Message Box */}
                        {message && (
                            <div className={`border px-4 py-3 rounded-xl mb-6 shadow-sm ${message.includes('Error') ? 'bg-red-100 border-red-400 text-red-700' : 'bg-rose-100 border-rose-400 text-rose-700'}`} role="alert">
                                <p className="font-semibold text-sm">{message}</p>
                            </div>
                        )}

                        {/* Content based on Active Tab */}
                        <main className="p-4 bg-white rounded-2xl shadow-2xl">
                            {activeTab === 'predict' && renderPredictionForm()}
                            {activeTab === 'leaderboard' && renderLeaderboard()}
                            {activeTab === 'admin' && renderAdminResultsInput()}
                        </main>

                        {/* Scoring Rules Footer */}
                        <footer className="mt-8 p-4 text-white rounded-xl shadow-lg" style={{ backgroundColor: '#360D3A' }}>
                            <h3 className="font-semibold text-lg mb-2">Scoring Rules:</h3>
                            <ul className="text-sm space-y-1">
                                <li><span className="font-bold" style={{color: '#E90052'}}>5 Points:</span> Exact score prediction (e.g., predicted 2-1, actual 2-1).</li>
                                <li><span className="font-bold" style={{color: '#E90052'}}>10 Points:</span> Exact score prediction *if* the game is a '6-goal thriller' (total goals $\ge$ 6, e.g., predicted 4-2, actual 4-2).</li>
                                <li><span className="font-bold" style={{color: '#E90052'}}>2 Points:</span> Correct match result (correct winner or a correct draw, but not the exact score).</li>
                            </ul>
                        </footer>
                    </div>
                </div>
            );
        };

        // Render the App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
